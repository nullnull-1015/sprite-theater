!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.SpriteTheater=e():t.SpriteTheater=e()}(self,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{ACTIONS:()=>w,ActionDispatcher:()=>c,Animation:()=>s,AnimationFolder:()=>a,AnimationManager:()=>o,AnimationTimesheet:()=>i,Animator:()=>d,ClickActionHandler:()=>y,JumpActionHandler:()=>_,Projector:()=>h,SeekActionHandler:()=>p,SeekAnimator:()=>u,SpriteSheet:()=>n,Theater:()=>f,TheaterGofer:()=>g,TimeAnimator:()=>m,Timer:()=>l});class i{constructor(t){if(this._duration=null,this._durationMap=new Map,0===t.length)throw new Error("Timesheet must not be empty.");this._frames=t}getFrame(t){return this._frames[t]}seekIndex(t){if(t<0)return 0;let e=0;for(const i of this._durationMap.keys()){if(t<i)return e;e++}return this.length}get length(){return this._frames.length}get duration(){if(null===this._duration){let t=0;for(const e of this._frames)t+=e.duration,this._durationMap.set(t,e);this._duration=t}return this._duration}}class s{constructor(t,e,s){this.paused=!1,this._currentIndex=0,this.DEFAULT_TYPE="time",this.type=t||this.DEFAULT_TYPE,this.spriteSheet=e,this.timesheet=new i(s)}async init(t=0){await this.spriteSheet.ready(),this._currentIndex=t}pause(){this.paused=!0}resume(){this.paused=!1}getStyle(t){return this.spriteSheet.getStyle(t)}getRenderingFrame(){const t=this.currentFrame;return t?{frameStyle:this.getStyle(this.currentFrame.frameName)||{},actions:t.actions||[]}:{frameStyle:{},actions:[]}}seekIndex(t){return this.timesheet.seekIndex(t)}get index(){return this._currentIndex}set index(t){this._currentIndex=t}get length(){return this.timesheet.length}get duration(){return this.timesheet.duration}get currentFrame(){return this.timesheet.getFrame(this.index)}}class n{constructor(t,e){this._img=new Image,this._frames=e,this._ready=new Promise((e,i)=>{this._img.onload=()=>e(),this._img.onerror=t=>i(t),this._img.src=t})}async ready(){return this._ready}getFrame(t){return this._frames[t]}getStyle(t){const e=this.getFrame(t);if(!e)return null;const{w:i,h:s,x:n,y:r}=e.frame,a=this._img.width,o=this._img.height;return{backgroundImage:`url(${this._img.src})`,backgroundPosition:`${n/(a-i+1e-12)*100}% ${r/(o+1e-12)*100}%`,backgroundSize:`${a/i*100}% ${o/s*100}%`,aspectRatio:`${i} / ${s}`,backgroundColor:""}}}class r{constructor(){this._cache={}}static getInstance(){return this.__loader||(this.__loader=new r),this.__loader}async load(t){if(!this._cache[t]){const e=t.lastIndexOf(":"),i=t.slice(0,e),s=await fetch(i),r=await s.json(),a=new n(r.meta.image,r.frames);Object.keys(r.animations).forEach(t=>{const e=`${i}:${t}`;if(!this._cache[e]){const i=r.animations[t],s=(null==i?void 0:i.type)||null,n=(null==i?void 0:i.frames)||[];this._cache[e]={type:s,spriteSheet:a,timesheet:n}}})}return this.get(t)}get(t){if(!this._cache[t])return;const{type:e,spriteSheet:i,timesheet:n}=this._cache[t];return new s(e,i,n)}has(t){return!!this._cache[t]}}class a{constructor(t){this._animations={},this._animations=t}async get(t){let e=this._animations[t];if(!e){const i=r.getInstance();e=await i.load(t),e&&this._addAnimation(t,e)}return e}_addAnimation(t,e){this._animations[t]=e}}class o{constructor(t){this._folder=new a({}),this.currentAnimator=null,this._animators=t}async play(t,e=0){var i;const s=await this._folder.get(t);if(!s)return;const n=this.getAnimator(s.type);n&&(null===(i=this.currentAnimator)||void 0===i||i.stop(),n.init(),await n.play(s,e),n.start(),this.currentAnimator=n)}start(){var t;null===(t=this.currentAnimator)||void 0===t||t.start()}stop(){var t;null===(t=this.currentAnimator)||void 0===t||t.stop()}setAnimator(t,e){this._animators[t]=e}getAnimator(t){return this._animators[t]}}class h{constructor(t){this._placeHolder=t,this._screen=document.createElement("div"),this._placeHolder.appendChild(this._screen)}cast(t){Object.assign(this._screen.style,t);const e=window.getComputedStyle(this._placeHolder);this._placeHolder.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)>=this._placeHolder.clientHeight-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom)?(this._screen.style.height="100%",this._screen.style.removeProperty("width")):(this._screen.style.width="100%",this._screen.style.removeProperty("height")),this._screen.offsetHeight}}class c{constructor(){this.handlers={}}register(t,e){void 0!==this.handlers[t]?this.handlers[t].add(e):this.handlers[t]=new Set([e])}remove(t,e){void 0!==this.handlers[t]&&this.handlers[t].delete(e)}async dispatch(t){const e=this.handlers[t.type];if(void 0!==e)for(const i of e)await i.handle(t);else console.warn(`No handler for action: ${t.type}`)}}class d{constructor(t){this._animation=null,this._listeners=t,this.init()}async play(t,e=0){t&&t.currentFrame&&(this._animation=t,await this._animation.init(e),this._requestRender([this._animation.getRenderingFrame()]))}_requestRender(t){this._listeners.forEach(e=>{e.request(t)})}}class l{constructor(){this._listener=new Set,this._running=!1,this._requestId=null,this._lastTime=performance.now(),this._update=()=>{const t=performance.now()-this._lastTime;this._running&&(this._listener.forEach(e=>e.update(t)),this._lastTime=performance.now())},this._loop=()=>{this._running&&(this._update(),this._requestId=requestAnimationFrame(this._loop))},this.start()}static getInstance(){return this.__timer||(this.__timer=new l),this.__timer}start(){this._running||(this._running=!0,this._lastTime=performance.now(),this._requestId=requestAnimationFrame(this._loop))}stop(){this._requestId&&(this._running=!1,cancelAnimationFrame(this._requestId))}add(t){this._listener.add(t)}remove(t){this._listener.delete(t)}}class m extends d{constructor(t){super(t),this._timer=l.getInstance(),this._elapsed=0,this._defaultDuration=1e3/60}init(){this._elapsed=0}start(){this._timer.add(this)}stop(){this._timer.remove(this)}update(t){if(!this._animation||this._animation.paused)return;const e=[];this._elapsed+=t;let i=this._animation.currentFrame,s=(null==i?void 0:i.duration)||this._defaultDuration;for(;this._elapsed>=s;){this._elapsed-=s;const t=this._animation.index;this._animation.index++,this._animation.index>=this._animation.length&&(this._animation.index=this._animation.length-1),s=(null==i?void 0:i.duration)||this._defaultDuration,i=this._animation.currentFrame,i&&this._animation.index!=t&&e.push(this._animation.getRenderingFrame())}this._requestRender(e)}}class _{constructor(t){this.theater=t}async handle(t){const{animeUri:e,frameIdx:i}=t.value;await this.theater.play(e,i||0)}}class u extends d{constructor(t,e){super(t),this._actionHandler=e}init(){}start(){this._actionHandler.add(this)}stop(){this._actionHandler.remove(this)}seek(t){if(!this._animation||this._animation.paused)return;t=Math.max(0,Math.min(t,1));const e=this._animation.duration*t,i=this._animation.seekIndex(e),s=Math.sign(i-this._animation.index);let n=this._animation.currentFrame;const r=[];for(;this._animation.index!=i;){const t=this._animation.index;this._animation.index+=s,this._animation.index>=this._animation.length&&(this._animation.index=this._animation.length-1),n=this._animation.currentFrame,n&&this._animation.index!=t&&r.push(this._animation.getRenderingFrame())}this._requestRender(r)}}class p{constructor(t){this.seekers=t}async handle(t){const{ratio:e}=t.value;void 0!==e&&this.seekers.forEach(t=>{t.seek(e)})}add(t){this.seekers.add(t)}remove(t){this.seekers.delete(t)}}class g{constructor(t){this._theater=t}request(t){this._theater.render(t)}}class f{constructor(t){this._dispatcher=new c,this._dispatcher.register("jump",new _(this));const e=new p(new Set([]));this._dispatcher.register("seek",e),this._projector=new h(t);const i=new g(this);this._manager=new o({time:new m([i]),seek:new u([i],e)})}async play(t,e=0){await this._manager.play(t,e)}start(){this._manager.start()}stop(){this._manager.stop()}render(t){for(const e of t)e.frameStyle&&this._projector.cast(e.frameStyle),this._dispatchActions(e.actions)}_dispatchActions(t){for(const e of t)this._dispatcher.dispatch(e)}get dispatcher(){return this._dispatcher}}class y{constructor(t){this._target=t}handle(t){this._target.click()}}const w={CLICK:"click",JUMP:"jump",SEEK:"seek"};return e})());